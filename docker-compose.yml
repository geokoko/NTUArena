services:
  redis:
    image: redis:7-alpine
    command: ["redis-server", "--requirepass", "${REDIS_PASSWORD}"]
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10

  mongo:
    image: mongo:latest
    hostname: mongo
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all", "--quiet"]
    networks:
      default:
        aliases:
          - mongo
    extra_hosts:
      - "mongo:127.0.0.1"
    environment:
      MONGO_INITDB_DATABASE: ${MONGO_DB}
    volumes:
      - mongo-data:/data/db
    healthcheck:
      test: ["CMD-SHELL", "mongosh --quiet --eval 'db.runCommand({ping:1}).ok' | grep 1"]
      interval: 5s
      timeout: 5s
      retries: 30

  # One-shot container: waits for mongod, initiates replica set, then exits
  mongo-init:
    image: mongo:latest
    depends_on:
      mongo:
        condition: service_started
    networks:
      default:
    restart: "no"
    entrypoint: >
      bash -c '
        echo "Waiting for mongod to accept connections..."
        until mongosh --host mongo --quiet --eval "db.runCommand({ping:1})" 2>/dev/null; do
          sleep 2
        done
        echo "Mongod is up. Initiating replica set..."
        mongosh --host mongo --quiet --eval "
          try {
            rs.initiate({ _id: \"rs0\", members: [{ _id: 0, host: \"mongo:27017\" }] });
            print(\"Replica set initiated!\");
          } catch (e) {
            if (/already initialized/i.test(e.message)) {
              print(\"Replica set already initialized.\");
            } else {
              print(\"Error: \" + e.message);
              quit(1);
            }
          }
        "
        echo "Done."
      '

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ntuarena-backend
    environment:
      PORT: ${PORT}
      MONGO_URI: ${MONGO_URI}
      MONGO_DB: ${MONGO_DB}
      REDIS_URL: ${REDIS_URL}
      NODE_ENV: ${NODE_ENV}
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN}
      AUTH_ENABLED: ${AUTH_ENABLED}
      CORS_ORIGIN: ${CORS_ORIGIN}
      APP_MODE: ${APP_MODE}
    depends_on:
      mongo:
        condition: service_healthy
      mongo-init:
        condition: service_completed_successfully
      redis:
        condition: service_healthy

  frontend:
    build:
      context: ./view
      dockerfile: Dockerfile.${APP_MODE:-dev}
    container_name: arena_frontend
    environment:
      CHOKIDAR_USEPOLLING: true
    volumes:
      - ./view/src:/app/src
    depends_on:
      - backend

  nginx:
    image: nginx:alpine
    container_name: ntuarena-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.${APP_MODE:-dev}.conf:/etc/nginx/nginx.conf:ro
      # Uncomment when SSL certificates are added 
      # - ./nginx/certs:/etc/nginx/certs:ro
    depends_on:
      - backend
      - frontend
    restart: unless-stopped

volumes:
  mongo-data:
